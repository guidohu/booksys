version: '3.3'

services:
    traefik:
        image: "traefik:latest"
        container_name: "traefik"
        network_mode: bridge
        command:
          #- "--log.level=DEBUG"
          - "--api.insecure=true"
          - "--providers.docker=true"
          - "--providers.docker.exposedbydefault=true"
          - "--entrypoints.web.address=:80"
        ports:
          - "81:80"
          - "8080:8080"
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock:ro"
    backend:
        image: booksys_api:latest
        container_name: "booksys_api"
        network_mode: bridge
        environment:
            DB_SERVER: 'db:3306'
            DB_NAME: 'booksys'
            DB_USER: 'user'
            DB_PASSWORD: 'userpassword'
        labels:
            - "traefik.http.routers.backend.rule=PathPrefix(`/api/`) || PathPrefix(`/api`)"
            - "traefik.http.services.backend.loadbalancer.server.port=80"
            # - traefik.http.middlewares.backend.stripprefix.prefixes=/backend
            # - traefik.http.middlewares.backend.stripprefix.forceslash=false
            # - "traefik.http.middlewares.remove-backend.stripprefix.prefixes="
            # - "traefik.http.routers.backend.middlewares=remove-backend@docker"
        volumes:
            - ${PWD}/../../backend/api:/var/www/html/api
            - ${PWD}/../../backend/classes:/var/www/html/classes
            - ${PWD}/../../backend/config/db:/var/www/html/config/db
    frontend:
        build: "./frontend"
        container_name: "booksys_ui"
        network_mode: bridge
        user: "node"
        working_dir: /home/node/app
        environment:
            - NODE_ENV=development
        volumes:
            - ../../frontend:/home/node/app
        # ports:
        #     - "8082:8080"
        labels:
            - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
            - "traefik.http.services.frontend.loadbalancer.server.port=8080"
        #command: "npm start"
        command: "npm run serve"
    
